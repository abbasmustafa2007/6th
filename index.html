<h3>التقارير</h3>
    <div id="reportsContent"></div>
  </section>

  <!-- Grades -->
  <section id="grades" class="card section-hidden">
    <h3>الدرجات</h3>
    <div id="gradesContent"></div>
  </section>

  <!-- Stats -->
  <section id="stats" class="card section-hidden">
    <h3>الإحصائيات</h3>
    <div id="statsContent"></div>
  </section>

  <!-- Archive -->
  <section id="archive" class="card section-hidden">
    <h3>الأرشيف</h3>
    <div id="archiveContent"></div>
  </section>

</div>

<!-- modal exam (same page) -->
<section id="examModal" class="section-hidden" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:820px;z-index:1100;background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.15);">
  <div style="text-align:left"><button id="closeExam" class="btn-small" style="background:#6c757d">إغلاق</button></div>
  <h3 id="examTitleShow"></h3>
  <div id="examQuestions"></div>
  <div style="margin-top:10px"><button id="submitExamBtn" class="btn-small" style="background:var(--accent)">إرسال الإجابات للتصحيح</button></div>
  <div id="examResult" style="margin-top:12px"></div>
</section>

<!-- load data file -->
<script src="data.js"></script>

<script>
/* Main index logic */
const sidebar=document.getElementById('sidebar');
const overlay=document.getElementById('overlay');
document.getElementById('menuBtn').addEventListener('click', ()=>{ sidebar.classList.add('open'); overlay.classList.add('show'); });
overlay.addEventListener('click', ()=>{ sidebar.classList.remove('open'); overlay.classList.remove('show'); });

// load data: priority - localStorage custom -> data.js
let DATA = JSON.parse(localStorage.getItem('DATA_CUSTOM')||'null');
if(!DATA){
  if(window.getInitialData) DATA = window.getInitialData();
  else DATA = {};
}
let RESULTS = JSON.parse(localStorage.getItem('RESULTS')||'[]');

function saveCustom(){ localStorage.setItem('DATA_CUSTOM', JSON.stringify(DATA)); localStorage.setItem('RESULTS', JSON.stringify(RESULTS)); }

// helpers
function todayISO(offset=0){ const d=new Date(); d.setDate(d.getDate()+offset); return d.toISOString().split('T')[0]; }
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function showTab(id){ ['dashboard','reports','grades','stats','archive','add'].forEach(x=> document.getElementById(x).classList.add('section-hidden')); document.getElementById(id).classList.remove('section-hidden'); sidebar.classList.remove('open'); overlay.classList.remove('show'); }
document.querySelectorAll('.navlink').forEach(n=> n.addEventListener('click', ()=> showTab(n.dataset.tab)));

// render dashboard (today)
function renderDashboard(){
  const today = todayISO();
  document.getElementById('todayDate').innerText = today;
  const list = (DATA[today] && DATA[today].tasks) ? DATA[today].tasks : [];
  const ul = document.getElementById('todayList'); ul.innerHTML='';
  list.forEach(t=>{
    if(t.done) return;
    const li = document.createElement('li');
    li.innerHTML = <div><strong>${t.subject}</strong><div style="font-size:13px;color:#555">${t.content} • ${t.hours} س</div></div><div><button class="btn-small markDone" data-id="${t.id}">✅</button></div>;
    ul.appendChild(li);
  });
  ul.querySelectorAll('.markDone').forEach(b=> b.addEventListener('click', ()=>{
    const id=b.dataset.id; const arr = DATA[today].tasks; const idx = arr.findIndex(x=>x.id===id);
    if(idx>-1){ arr[idx].done=true; saveCustom(); renderDashboard(); renderStats(); renderReports(); }
  }));

  // exams
  const exams = (DATA[today] && DATA[today].exams) ? DATA[today].exams : [];
  const exUl = document.getElementById('todayExams'); exUl.innerHTML='';
  exams.forEach(e=>{
    const li = document.createElement('li');
    li.innerHTML = <div><strong>${e.title}</strong><div style="font-size:13px;color:#555">${e.subject}</div></div><div><button class="btn-small startExam" data-id="${e.id}">ابدأ الامتحان</button></div>;
    exUl.appendChild(li);
  });
  exUl.querySelectorAll('.startExam').forEach(b=> b.addEventListener('click', ()=> openExam(today,b.dataset.id)));
}

// open exam (modal)
function openExam(date,examId){
  const ex = (DATA[date] && DATA[date].exams) ? DATA[date].exams.find(x=>x.id===examId) : null;
  if(!ex) return alert('الامتحان غير موجود');
  showTab('dashboard');
  document.getElementById('examTitleShow').innerText = ex.title + ' • ' + ex.subject;
  const area = document.getElementById('examQuestions'); area.innerHTML='';
  ex.questions.forEach((q,idx)=>{
    const div = document.createElement('div'); div.style.marginTop='10px';
    div.innerHTML = <div><strong>س${idx+1}:</strong> ${q.text}</div><div><textarea name="q${idx}" style="width:100%;height:80px;padding:6px;margin-top:6px"></textarea></div>;
    area.appendChild(div);
  });
  document.getElementById('examResult').innerHTML='';
  document.getElementById('examModal').classList.remove('section-hidden');
  overlay.classList.add('show');

  document.getElementById('submitExamBtn').onclick = function(){
    const answers = ex.questions.map((q,idx)=> (document.querySelector(`textarea[name="q${idx}"]`).value||'').trim());
    let correct = 0;
    const details = ex.questions.map((q,idx)=>{ const ok = (answers[idx]||'').toLowerCase() === (q.answer||'').toLowerCase(); if(ok) correct++; return { question:q.text, given:answers[idx]||'', answer:q.answer||'', correct: ok }; });
    const score = Math.round((correct / ex.questions.length) * 100);
    RESULTS.push({ examId: ex.id, title: ex.title, subject: ex.subject, date: date, score: score, details: details });
    saveCustom();
    let html = <div><strong>النتيجة: ${score} / 100</strong></div><hr>;
    details.forEach((d,i)=>{ html += <div><strong>س${i+1}:</strong> ${d.question}<br><strong>إجابتك:</strong> ${d.given}<br><strong>الإجابة الصحيحة:</strong> ${d.answer}<br><strong>الحالة:</strong> ${d.correct ? '✅' : '❌'}</div><hr>; });
    document.getElementById('examResult').innerHTML = html;
    renderGrades(); renderReports(); renderStats();
  };
}
document.getElementById('closeExam').addEventListener('click', ()=>{ document.getElementById('examModal').classList.add('section-hidden'); overlay.classList.remove('show'); });

// Add new task
document.getElementById('saveTask').addEventListener('click', ()=>{
  const sub = document.getElementById('new_subject').value.trim();
  const cont = document.getElementById('new_content').value.trim();
  const hrs = parseInt(document.getElementById('new_hours').value) || 1;
  const date = document.getElementById('new_date').value || todayISO();
  if(!sub || !cont){ alert('اكمل الحقول'); return; }
  const t = { id: 't-'+date+'-'+uid(), subject: sub, content: cont, hours: hrs, done:false };
  DATA[date] = DATA[date] || { tasks: [], exams: [] };
  DATA[date].tasks.push(t);
  saveCustom();
  alert('تمت إضافة الواجب');
  showTab('dashboard');
  renderDashboard();
});

// render grades
function renderGrades(){
  const container = document.getElementById('gradesContent'); container.innerHTML='';
  if(RESULTS.length===0){ container.innerHTML = '<div class="card">لا توجد نتائج بعد.</div>'; return; }
  let html = '<table style="width:100%;border-collapse:collapse"><tr><th style="text-align:right;padding:8px">التاريخ</th><th style="text-align:right;padding:8px">المادة</th><th style="text-align:right;padding:8px">الامتحان</th><th style="text-align:right;padding:8px">الدرجة</th></tr>';
  RESULTS.slice().reverse().forEach(r=> html += `<tr><td style="padding:8px">${r.date}</td><td style="padding:8px">${r.subject}</td><td style="padding:8px">${r.title}</td><td style="padding:8px">${r.score}</td></tr>`);
  html += '</table>';
  container.innerHTML = html;
}

// reports
function renderReports(){
  const container = document.getElementById('reportsContent'); container.innerHTML='';
  let totalPlanned=0, totalDone=0, totalExams=0;
  for(let i=0;i<7;i++){
    const d = todayISO(-i);
    const day = DATA[d];
    if(day){
      const tasks = day.tasks||[];
      totalPlanned += tasks.reduce((a,b)=>a+(b.hours||0),0);
      totalDone += tasks.filter(t=>t.done).reduce((a,b)=>a+(b.
