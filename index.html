<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Dashboard - لوحة الواجبات والإنجاز</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--accent:#2b8aeb;--ok:#28a745;--danger:#e55353;}
  body{font-family: "Segoe UI", Tahoma, Arial; background:var(--bg); direction:rtl; margin:0; padding:16px; color:#222;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:6px 0}
  .top-actions{display:flex;gap:8px;align-items:center}
  button{cursor:pointer;padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#fff}
  .secondary{background:#6c757d}
  .container{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:12px}
  .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
  form label{display:block;margin-top:8px;font-size:14px}
  input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea{
    width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:4px;box-sizing:border-box;font-size:14px
  }
  #dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .day{padding:10px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfdff);min-height:120px}
  .day h3{font-size:14px;margin:0 0 6px 0}
  .tasks{list-style:none;padding:0;margin:0 0 6px 0;max-height:150px;overflow:auto}
  .tasks li{padding:6px;border-radius:6px;margin-bottom:6px;background:#f7f9fc;border:1px solid #eef2fb;display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:13px}
  .tasks li .meta{font-size:12px;color:#555}
  .badge{padding:3px 6px;border-radius:999px;font-size:12px}
  .priority-high{background:#ffd6d6;color:#800}
  .priority-med{background:#fff0c2;color:#8a5a00}
  .priority-low{background:#dff3e6;color:#116b2f}
  .progress{background:#e9eef7;border-radius:6px;height:12px;overflow:hidden;margin-top:8px}
  .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--ok),#2ec27e);transition:width .4s}
  nav{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .tab{padding:8px 10px;border-radius:6px;background:#fff;border:1px solid #e6eefb;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}
  .hidden{display:none}
  .flex{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px;border-bottom:1px solid #eee;text-align:right;font-size:13px}
  .small{font-size:12px;color:#666}
  .archive-list li{display:flex;justify-content:space-between;gap:12px;padding:6px;border-radius:6px;background:#fbfbfb;margin-bottom:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .chart-wrap{display:flex;gap:12px;flex-wrap:wrap}
  canvas{background:#fff;border-radius:8px;padding:8px}
  footer{margin-top:14px;font-size:13px;color:#666}
  .points{font-weight:bold;color:var(--accent)}
  @media(max-width:900px){.container{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <div>
    <h1>لوحة المذاكرة والواجبات (30 يوم)</h1>
    <div class="small">مخزون المهام، تتبع الساعات، تقرير يومي/أسبوعي، وإحصائيات</div>
  </div>
  <div class="top-actions">
    <button id="notifyPermBtn" class="secondary">طلب إذن إشعارات</button>
    <button id="exportBtn">تصدير CSV</button>
    <button id="clearBtn" class="secondary">مسح كل البيانات</button>
  </div>
</header>

<nav id="tabs" class="card">
  <span class="tab active" data-tab="dashboard">Dashboard</span>
  <span class="tab" data-tab="reports">التقارير</span>
  <span class="tab" data-tab="analytics">الإحصائيات</span>
  <span class="tab" data-tab="archive">الأرشيف</span>
  <span class="tab" data-tab="settings">الإعدادات</span>
</nav>

<div class="container">
  <!-- الشريط الأيسر: نموذج الإضافة + النقاط والـ Badges -->
  <aside>
    <div class="card">
      <h3>أضف واجب / ملاحظة</h3>
      <form id="taskForm">
        <label>التاريخ</label>
        <input type="date" id="date" required>

        <label>الوقت (اختياري - لتذكير بمحدد)</label>
        <input type="time" id="time">

        <label>المادة / الموضوع</label>
        <input type="text" id="subject" placeholder="مثال: كيمياء - الفصل الاول" required>

        <label>وصف الواجب</label>
        <input type="text" id="content" placeholder="مثلاً: مذاكرة فصل 1 أو واجب صفحة 12" required>

        <label>عدد الساعات المخصصة</label>
        <input type="number" id="hours" min="1" value="1" required>

        <label>الأولوية</label>
        <select id="priority">
          <option value="high">عالية</option>
          <option value="med" selected>متوسطة</option>
          <option value="low">منخفضة</option>
        </select>

        <label>تذكير قبل (دقائق) - 0 = لا تذكير</label>
        <input type="number" id="reminder" min="0" value="30">

        <div style="margin-top:10px;display:flex;gap:8px">
          <button type="submit">➕ إضافة</button>
          <button type="button" id="addFromList" class="secondary">إضافة كمجموعة</button>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>نقاطك وBadges</h3>
      <div>النقاط: <span id="points" class="points">0</span></div>
      <div id="badges" style="margin-top:8px"></div>
      <div class="small" style="margin-top:8px">نقاط تكسبها = مجموع الساعات المكتملة × 10</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>التحكم السريع</h3>
      <div class="controls">
        <button id="markAllDone">وضع كل يوم الحالي كمكتمل</button>
        <button id="exportJSON" class="secondary">تصدير JSON</button>
      </div>
      <div class="small" style="margin-top:8px">ملحوظة: التذكيرات تعمل أثناء فتح/زيارتك للموقع بعد منح الإذن.</div>
    </div>
  </aside>

  <!-- الجزء الأيمن: تبويبات المحتوى -->
  <main>
    <!-- Dashboard -->
    <section id="dashboardTab" class="card">
      <h2>لوحة الـ 30 يوم</h2>
      <div id="dashboard"></div>
    </section>

    <!-- Reports -->
    <section id="reportsTab" class="card hidden">
      <h2>التقارير</h2>
      <div id="dailyReport" class="card" style="margin-bottom:10px"></div>
      <div id="weeklyReport" class="card"></div>
    </section>

    <!-- Analytics -->
    <section id="analyticsTab" class="card hidden">
      <h2>الإحصائيات</h2>
      <div class="chart-wrap">
        <div style="flex:1;min-width:280px">
          <h4>توزيع الساعات حسب المادة</h4>
          <canvas id="subjectChart" width="400" height="240"></canvas>
        </div>
        <div style="flex:1;min-width:280px">
          <h4>نسبة الإنجاز لآخر 7 أيام</h4>
          <canvas id="progressChart" width="400" height="240"></canvas>
        </div>
      </div>
      <div style="margin-top:12px" id="analyticsSummary"></div>
    </section>

    <!-- Archive -->
    <section id="archiveTab" class="card hidden">
      <h2>الأرشيف - المهام المنجزة</h2>
      <ul id="archiveList" class="archive-list"></ul>
    </section>

    <!-- Settings -->
    <section id="settingsTab" class="card hidden">
      <h2>الإعدادات</h2>
      <div class="small">خيارات متقدمة</div>
      <label>مدة عرض الـ Dashboard (أيام)</label>
      <input type="number" id="daysCount" value="30" min="7" max="90">
      <div style="margin-top:8px">
        <button id="applyDays">تطبيق</button>
      </div>
    </section>
  </main>
</div>

<footer class="small">صُنع لك — ارفع الملف `index.html` على GitHub Pages لتشغيل الموقع مباشرة. أقدر أضيف لك Git workflow لو تريد نشر تلقائي.</footer>

<script>
/* -------------------------
  Setup & Storage structure
   tasksData = {
     dateISO: [ { id, subject, content, hours, priority, time (HH:MM or ""), reminderMinutes:int, done:bool, createdAt:timestamp } ],
     ...
   }
--------------------------*/

const dashboardEl = document.getElementById('dashboard');
const DAYS_DEFAULT = parseInt(localStorage.getItem('daysCount')||30);
let DAYS = DAYS_DEFAULT;
const today = new Date();
let tasksData = JSON.parse(localStorage.getItem('tasksData')) || {};
let points = parseInt(localStorage.getItem('points')||0);
let badges = JSON.parse(localStorage.getItem('badges')||[]);
const pointEl = document.getElementById('points');
const badgesEl = document.getElementById('badges');

function saveAll(){
  localStorage.setItem('tasksData', JSON.stringify(tasksData));
  localStorage.setItem('points', points);
  localStorage.setItem('badges', JSON.stringify(badges));
  localStorage.setItem('daysCount', DAYS);
}

/* -------------------------
  Tabs
--------------------------*/
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    showTab(tab);
  });
});
function showTab(name){
  ['dashboard','reports','analytics','archive','settings'].forEach(n=>{
    document.getElementById(n + 'Tab').classList.toggle('hidden', n!==name);
  });
  if(name==='analytics') renderAnalytics();
  if(name==='reports') renderReports();
  if(name==='archive') renderArchive();
}

/* -------------------------
  Build dashboard days
--------------------------*/
function buildDashboard(){
  dashboardEl.innerHTML = '';
  const base = new Date(); base.setHours(0,0,0,0);
  for(let i=0;i<DAYS;i++){
    const d = new Date(base); d.setDate(base.getDate()+i);
    const iso = d.toISOString().split('T')[0];
    const dayCard = document.createElement('div'); dayCard.className='day card-day card';
    dayCard.dataset.date = iso;
    dayCard.innerHTML = `<h3>${formatDateLabel(d)}</h3><ul class="tasks"></ul><div class="progress"><div class="progress-bar"></div></div>`;
    dashboardEl.appendChild(dayCard);
  }
  renderAllTasks();
}
function formatDateLabel(d){
  const options = {weekday:'short', month:'short', day:'numeric'};
  // keep Arabic locale for labels
  try { return d.toLocaleDateString('ar-EG', options); } catch(e){ return d.toISOString().split('T')[0];}
}

/* -------------------------
  Add task form
--------------------------*/
document.getElementById('taskForm').addEventListener('submit', e=>{
  e.preventDefault();
  const date = document.getElementById('date').value;
  const time = document.getElementById('time').value; // HH:MM
  const subject = document.getElementById('subject').value.trim();
  const content = document.getElementById('content').value.trim();
  const hours = parseInt(document.getElementById('hours').value) || 1;
  const priority = document.getElementById('priority').value;
  const reminder = parseInt(document.getElementById('reminder').value)||0;

  if(!date || !subject || !content){ alert('اكمل الحقول المطلوبة'); return; }

  const task = {
    id: 't'+Date.now() + Math.random().toString(36).slice(2,7),
    subject, content, hours, priority, time, reminder, done:false,
    createdAt: Date.now()
  };
  if(!tasksData[date]) tasksData[date]=[];
  tasksData[date].push(task);
  saveAll();
  renderAllTasks();
  scheduleReminderForTask(date, task);
  e.target.reset();
});

/* -------------------------
  Render tasks & progress
--------------------------*/
function renderAllTasks(){
  document.querySelectorAll('.day').forEach(dayCard=>{
    const date = dayCard.dataset.date;
    const ul = dayCard.querySelector('.tasks');
    ul.innerHTML = '';
    const list = tasksData[date] || [];
    list.forEach(task=>{
      const li = document.createElement('li');
      li.dataset.id = task.id;
      li.dataset.hours = task.hours;
      li.innerHTML = `<div style="flex:1">
          <div><strong>${escapeHtml(task.subject)}</strong></div>
          <div class="small">${escapeHtml(task.content)}</div>
        </div>
        <div style="text-align:left">
          <div class="meta">${task.hours}س ${task.time? ' - ' + task.time : ''}</div>
          <div style="margin-top:6px">
            <span class="badge ${priorityClass(task.priority)}">${priorityLabel(task.priority)}</span>
          </div>
        </div>`;
      if(task.done){
        li.style.display='none';
      } else {
        li.style.display='';
      }
      // click to mark done
      li.addEventListener('click', ()=>{
        markTaskDone(date, task.id);
      });
      ul.appendChild(li);
    });
    updateProgressForDay(dayCard);
  });
  updatePointsUI();
}

/* helpers */
function priorityLabel(p){ if(p==='high') return 'عالية'; if(p==='med') return 'متوسطة'; return 'منخفضة'; }
function priorityClass(p){ if(p==='high') return 'priority-high'; if(p==='med') return 'priority-med'; return 'priority-low'; }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function updateProgressForDay(dayCard){
  const date = dayCard.dataset.date;
  const list = tasksData[date] || [];
  let total=0, done=0;
  list.forEach(t=>{
    total += t.hours;
    if(t.done) done += t.hours;
  });
  const percent = total ? Math.round((done/total)*100) : 0;
  dayCard.querySelector('.progress-bar').style.width = percent + '%';
}

/* -------------------------
  Mark done -> archive -> points & badges
--------------------------*/
function markTaskDone(date, id){
  const list = tasksData[date] || [];
  const idx = list.findIndex(t=>t.id===id);
  if(idx===-1) return;
  list[idx].done = true;
  // move to archive (we keep it in tasksData but flag done; also push to archive store)
  // add points
  const earned = (list[idx].hours || 0) * 10;
  points += earned;
  addBadgeIfNeeded();
  saveAll();
  renderAllTasks();
  // delay moving to archive visually (we hide already)
  addToArchive(date, list[idx]);
}
function addToArchive(date, task){
  if(!localStorage.getItem('archive')) localStorage.setItem('archive', JSON.stringify([]));
  const arr = JSON.parse(localStorage.getItem('archive'));
  arr.unshift(Object.assign({date}, task));
  localStorage.setItem('archive', JSON.stringify(arr));
}

/* Badges logic */
function addBadgeIfNeeded(){
  const newBadges = [];
  if(points >= 500 && !badges.includes('500')) newBadges.push('500');
  if(points >= 250 && !badges.includes('250')) newBadges.push('250');
  if(points >= 100 && !badges.includes('100')) newBadges.push('100');
  if(newBadges.length) badges = badges.concat(newBadges);
  saveAll();
}
function updatePointsUI(){
  pointEl.innerText = points;
  badgesEl.innerHTML = '';
  if(badges.length===0) badgesEl.innerHTML = '<div class="small">لم تحصل على badges بعد. استمر!</div>';
  badges.forEach(b=>{
    const el = document.createElement('span');
    el.className='badge priority-high';
    el.style.marginRight='6px';
    el.innerText = 'Badge '+ b + ' نقطة';
    badgesEl.appendChild(el);
  });
}

/* -------------------------
  Archive rendering
--------------------------*/
function renderArchive(){
  const listEl = document.getElementById('archiveList');
  listEl.innerHTML = '';
  const arr = JSON.parse(localStorage.getItem('archive') || '[]');
  if(arr.length===0){ listEl.innerHTML = '<div class="small">لا توجد مهام منجزة بعد.</div>'; return; }
  arr.forEach(item=>{
    const li = document.createElement('li');
    li.innerHTML = `<div><strong>${escapeHtml(item.subject)}</strong><div class="small">${escapeHtml(item.content)} • ${item.hours}س</div></div>
      <div class="small">${item.date}</div>`;
    listEl.appendChild(li);
  });
}

/* -------------------------
  Reports rendering (daily + weekly)
--------------------------*/
function renderReports(){
  // daily = today
  const todayISO = (new Date()).toISOString().split('T')[0];
  const dayList = tasksData[todayISO] || [];
  let total=0, done=0;
  const completedSubjects = [], leftSubjects=[];
  dayList.forEach(t=>{
    total+=t.hours;
    if(t.done){ done+=t.hours; completedSubjects.push(t.subject); } else leftSubjects.push(t.subject);
  });
  const percent = total ? Math.round((done/total)*100) : 0;
  const dailyEl = document.getElementById('dailyReport');
  dailyEl.innerHTML = `<h3>تقرير اليوم (${todayISO})</h3>
    <div>درست: ${done} / ${total} ساعة (${percent}%)</div>
    <div>المواد المكتملة: ${completedSubjects.length? completedSubjects.join(', ') : 'لا توجد'}</div>
    <div>المواد المتبقية: ${leftSubjects.length? leftSubjects.join(', ') : 'لا توجد'}</div>
    <div style="margin-top:8px">النقاط الكلية: <strong>${points}</strong></div>
  `;

  // weekly = آخر 7 أيام من اليوم (بما فيها اليوم)
  const weekArr = [];
  const labels = [];
  const doneArr = [];
  const totalArr = [];
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate() - i);
    const iso = d.toISOString().split('T')[0];
    labels.push(iso);
    const list = tasksData[iso] || [];
    let t=0, c=0;
    list.forEach(x=>{ t+=x.hours; if(x.done) c+=x.hours; });
    totalArr.push(t); doneArr.push(c);
    weekArr.push({date:iso, total:t, done:c});
  }
  const weeklyEl = document.getElementById('weeklyReport');
  let summary = '';
  const totalWeek = totalArr.reduce((a,b)=>a+b,0);
  const doneWeek = doneArr.reduce((a,b)=>a+b,0);
  const pctW = totalWeek ? Math.round((doneWeek/totalWeek)*100) : 0;
  summary += `<div>مجموع الساعات للأسبوع: ${doneWeek} من ${totalWeek} ( ${pctW}% )</div>`;
  // best day
  let bestDay = weekArr.reduce((best, cur) => cur.done > (best.done||0) ? cur : best, {});
  if(bestDay.date) summary += `<div>أفضل يوم (من حيث ساعات المنجزة): ${bestDay.date} - ${bestDay.done} س</div>`;
  weeklyEl.innerHTML = `<h3>تقرير أسبوعي (آخر 7 أيام)</h3>${summary}<div style="margin-top:8px" class="small">تفاصيل: ${labels.map((l,i)=>`${l}: ${doneArr[i]}/${totalArr[i]} س`).join(' • ')}</div>`;
}

/* -------------------------
  Analytics (simple charts using canvas)
--------------------------*/
function renderAnalytics(){
  // subject distribution across all upcoming 30 days
  const subjMap = {};
  Object.keys(tasksData).forEach(date=>{
    tasksData[date].forEach(t=>{
      if(!subjMap[t.subject]) subjMap[t.subject]=0;
      subjMap[t.subject]+=t.hours;
    });
  });
  const labels = Object.keys(subjMap);
  const values = labels.map(l=>subjMap[l]);

  drawBarChart('subjectChart', labels, values, 'ساعات');

  // progress last 7 days
  const labels7=[], percents=[];
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate() - i);
    const iso = d.toISOString().split('T')[0];
    labels7.push(iso);
    const list = tasksData[iso] || [];
    let total=0,done=0;
    list.forEach(t=>{ total+=t.hours; if(t.done) done+=t.hours; });
    const pct = total ? Math.round((done/total)*100) : 0;
    percents.push(pct);
  }
  drawLineChart('progressChart', labels7, percents, '% إنجاز');

  // summary
  const totalHours = values.reduce((a,b)=>a+b,0);
  document.getElementById('analyticsSummary').innerHTML = `<div>إجمالي الساعات المجدولة: ${totalHours} س</div><div>مواد موجودة: ${labels.length}</div>`;
}

/* drawing simple bar chart */
function drawBarChart(canvasId, labels, values, unit){
  const cv = document.getElementById(canvasId);
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);
  const W = cv.width, H = cv.height;
  const padding = 30;
  const maxVal = Math.max(1, ...values);
  const barW = (W - padding*2) / Math.max(1, labels.length);
  labels.forEach((lab, i)=>{
    const val = values[i];
    const x = padding + i*barW + 6;
    const h = Math.round((H - padding*1.5) * (val / maxVal));
    const y = H - padding - h;
    ctx.fillStyle = '#2b8aeb';
    ctx.fillRect(x, y, barW - 12, h);
    ctx.fillStyle = '#222';
    ctx.font = '11px sans-serif';
    ctx.textAlign='center';
    ctx.fillText(lab.length>10? lab.slice(0,10)+'…' : lab, x + (barW-12)/2, H - padding + 12);
    ctx.fillText(val + ' ' + unit, x + (barW-12)/2, y - 6);
  });
}

/* drawing line chart */
function drawLineChart(canvasId, labels, values, unit){
  const cv = document.getElementById(canvasId);
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);
  const W = cv.width, H = cv.height;
  const padding = 30;
  const maxVal = Math.max(100, ...values);
  ctx.beginPath();
  labels.forEach((lab,i)=>{
    const x = padding + (i*(W - padding*2)/(labels.length-1||1));
    const y = H - padding - ( (H - padding*2) * (values[i]/maxVal) );
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#2b8aeb';
  ctx.lineWidth = 2;
  ctx.stroke();
  // points
  labels.forEach((lab,i)=>{
    const x = padding + (i*(W - padding*2)/(labels.length-1||1));
    const y = H - padding - ( (H - padding*2) * (values[i]/maxVal) );
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = '#2b8aeb'; ctx.stroke();
    ctx.fillStyle='#222'; ctx.font='11px sans-serif'; ctx.fillText(values[i] + unit, x, y-10);
    ctx.fillText(lab, x, H - padding + 12);
  });
}

/* -------------------------
  Export CSV / JSON
--------------------------*/
document.getElementById('exportBtn').addEventListener('click', exportCSV);
document.getElementById('exportJSON').addEventListener('click', exportJSON);

function exportCSV(){
  const rows = [['date','subject','content','hours','priority','time','reminder','done','createdAt']];
  Object.keys(tasksData).forEach(date=>{
    tasksData[date].forEach(t=>{
      rows.push([date, escapeCsv(t.subject), escapeCsv(t.content), t.hours, t.priority, t.time||'', t.reminder||0, t.done, t.createdAt]);
    });
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  downloadBlob(csv, 'text/csv', 'study-dashboard.csv');
}
function exportJSON(){
  const blob = JSON.stringify({tasksData, points, badges, archive: JSON.parse(localStorage.getItem('archive')||'[]')}, null, 2);
  downloadBlob(blob, 'application/json', 'study-dashboard.json');
}
function escapeCsv(s){ return `"${String(s).replace(/"/g,'""')}"`; }
function downloadBlob(content,type,filename){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* -------------------------
  Clear data
--------------------------*/
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(!confirm('تأكيد مسح كل البيانات (غير قابل للاسترجاع إلا عبر تصدير json سابق)؟')) return;
  localStorage.clear(); tasksData={}; points=0; badges=[]; saveAll(); buildDashboard();
  alert('تم المسح');
});

/* -------------------------
  Settings days count
--------------------------*/
document.getElementById('applyDays').addEventListener('click', ()=>{
  const v = parseInt(document.getElementById('daysCount').value)||30;
  DAYS = Math.min(90, Math.max(7, v));
  saveAll();
  buildDashboard();
});

/* -------------------------
  Mark all current day done
--------------------------*/
document.getElementById('markAllDone').addEventListener('click', ()=>{
  const todayISO = (new Date()).toISOString().split('T')[0];
  const list = tasksData[todayISO] || [];
  list.forEach(t=>{ if(!t.done){ t.done=true; addToArchive(todayISO, t); points += (t.hours*10); }});
  addBadgeIfNeeded(); saveAll(); renderAllTasks();
});

/* -------------------------
  Archive export helper for operations
--------------------------*/
document.getElementById('addFromList').addEventListener('click', ()=>{
  // Quick example: اضافة مجموعة مهام (تجربة) - يمكن حذفه لاحقاً
  const baseDate = (new Date()).toISOString().split('T')[0];
  const sample = [
    {subject:'رياضيات', content:'مراجعة مسائل تكامل', hours:2, priority:'high', time:'', reminder:30, done:false},
    {subject:'كيمياء', content:'حل تمارين الفصل2', hours:2, priority:'med', time:'', reminder:30, done:false}
  ];
  tasksData[baseDate] = (tasksData[baseDate]||[]).concat(sample.map(s=>Object.assign({id:'t'+Date.now()+Math.random().toString(36).slice(2,5),createdAt:Date.now()}, s))));
  saveAll(); renderAllTasks();
});

/* -------------------------
  Reminders (Notification API)
--------------------------*/
document.getElementById('notifyPermBtn').addEventListener('click', async ()=>{
  if(!('Notification' in window)){ alert('المتصفح لا يدعم إشعارات سطح المكتب'); return; }
  const perm = await Notification.requestPermission();
  alert('حالة الإذن: ' + perm);
  if(perm==='granted') scheduleAllReminders();
});

function scheduleAllReminders(){
  Object.keys(tasksData).forEach(date=>{
    tasksData[date].forEach(t=> scheduleReminderForTask(date, t));
  });
}
function scheduleReminderForTask(dateISO, task){
  if(!task.reminder) return;
  if(!task.time) return; // يحتاج وقت محدد
  try{
    const [yy,mm,dd] = dateISO.split('-').map(Number);
    const [hh,mins] = task.time.split(':').map(Number);
    const dt = new Date(yy, mm-1, dd, hh, mins, 0, 0);
    const remindAt = new Date(dt.getTime() - (task.reminder||0)*60000);
    const now = new Date();
    const delay = remindAt.getTime() - now.getTime();
    if(delay<=0) return; // فات أو حالي
    // setTimeout is session-limited; will run only while page open
    setTimeout(()=> {
      if(Notification.permission==='granted'){
        new Notification('تذكير واجب', { body: `${task.subject}: ${task.content} - ${task.hours}س`});
      }
    }, delay);
  }catch(e){}
}

/* -------------------------
  On load
--------------------------*/
function init(){
  DAYS = parseInt(localStorage.getItem('daysCount')||30);
  document.getElementById('daysCount').value = DAYS;
  buildDashboard();
  // show points/badges
  updatePointsUI();
  // schedule any reminders for tasks that have time & reminder
  if(Notification.permission==='granted') scheduleAllReminders();
}
init();

/* -------------------------
  Utilities
--------------------------*/
function renderAll(){
  renderAllTasks();
  renderReports();
  renderAnalytics();
  renderArchive();
}
function renderTasksForDate(date){
  // helper to re-render specific day
  const dayCard = document.querySelector(`.day[data-date="${date}"]`);
  if(!dayCard) return;
  const ul = dayCard.querySelector('.tasks'); ul.innerHTML='';
  (tasksData[date]||[]).forEach(task=>{
    const li = document.createElement('li'); li.dataset.id=task.id; li.dataset.hours=task.hours;
    li.innerHTML = `<div style="flex:1"><div><strong>${escapeHtml(task.subject)}</strong></div><div class="small">${escapeHtml(task.content)}</div></div>
      <div style="text-align:left"><div class="meta">${task.hours}س ${task.time? ' - ' + task.time : ''}</div><div style="margin-top:6px"><span class="badge ${priorityClass(task.priority)}">${priorityLabel(task.priority)}</span></div></div>`;
    if(task.done) li.style.display='none';
    li.addEventListener('click', ()=>{ markTaskDone(date, task.id); saveAll(); });
    ul.appendChild(li);
  });
  updateProgressForDay(dayCard);
}

/* -------------------------
  Helper: when storage changes in other tab
--------------------------*/
window.addEventListener('storage', (e)=>{
  if(e.key==='tasksData' || e.key==='points' || e.key==='badges'){
    tasksData = JSON.parse(localStorage.getItem('tasksData')||'{}');
    points = parseInt(localStorage.getItem('points')||0);
    badges = JSON.parse(localStorage.getItem('badges')||'[]');
    buildDashboard();
  }
});

/* -------------------------
  Initial rendering update calls
--------------------------*/
function updateAllProgress(){
  document.querySelectorAll('.day').forEach(updateProgressForDay);
}
updateAllProgress();
</script>

</body>
</html>